# 機能設計書

## 概要
- **プロジェクト名**: OffPath - 真の隠れ名所発見サービス
- **設計方針**: フロントエンドデザインとサービス設計書に基づく機能設計
- **アーキテクチャ準拠**: docs/architecture_guideline.md

## サービス概要

OffPathは、観光客というよりかは現地人に人気な「真の隠れ名所」だけを厳選し、あなたの冒険譚を作るための旅行計画サービスです。AIが現地メディア情報やマップアプリを解析して情報を収集、旅行者からの要望に応じて話せる言語でのレビューや旅行記事が存在する場所を取り除き「観光客がまだあまり知らないけれど、本当に価値のある場所」だけを発見します。

## 機能要件分析

### 1. ランディングページ機能

#### 機能概要
- サービスの価値提案を伝える
- ユーザーの問題意識（「また同じような観光地巡り」「本当に現地の人に人気のお店を探したいけど現地語が分からないし、ハズレのお店に行くのが怖い」）への共感喚起
- 認証ページへの導線

#### 機能詳細
- **ヒーローセクション**: サービスのコンセプト「誰も知らない本物の旅を見つけよう」
- **問題提起セクション**: 既存の旅行の悩みを具体的に表現
- **ソリューション紹介**: 隠れ名所発見エンジン、カオス旅程ジェネレーター、現地サポートシステム
- **特徴説明**: 真の現地体験、独占的な体験、予測不可能な刺激、ストーリー性
- **CTA**: 認証ページへの遷移

#### フロントエンド/バックエンド分担
- **フロントエンド**: 静的コンテンツ表示、レスポンシブ対応、ナビゲーション
- **バックエンド**: 不要（静的ページ）

### 2. ユーザー認証機能

#### 機能概要
- ユーザーの登録、ログイン、ログアウト機能
- Google認証と匿名認証の両方をサポート
- セッション管理とアクセス制御

#### 認証・認可設計
- **認証方式**: Firebase Authentication + IDトークン
- **認証プロバイダー**: 
  - Google認証（主要認証方式）
  - 匿名認証（ゲストユーザー向け、アカウント作成不要でサービス体験可能）
- **有効期限**: Firebase Authentication標準（1時間、自動リフレッシュ）
- **セッション管理**: Firebase Authentication のセッション機能を使用

#### フロントエンド/バックエンド分担
- **フロントエンド**: 
  - ログインフォーム表示
  - Firebase Authentication連携
  - 認証状態管理（ログイン/ログアウト状態の保持）
  - 認証後のリダイレクト制御（ダッシュボードへ遷移）
- **バックエンド**: 
  - IDトークン検証（Firebase Admin SDK）
  - ユーザー情報のDB保存・管理
  - 初回ログイン時のユーザー作成処理
  - 認証ミドルウェアによるAPI保護

#### セキュリティ要件
- Firebase AuthenticationのIDトークン検証
- HTTPSでの通信
- XSS対策（Content Security Policy）
- CSRF対策

### 3. ダッシュボード機能

#### 機能概要
- ユーザーの旅行統計表示
- 最近の旅行履歴管理
- 新しい冒険の開始ポイント
- 発見の洞察とコミュニティ情報表示

#### データ設計
- **主要エンティティ**: ユーザー、旅行、統計データ
- **統計情報**: 総旅行数、発見した隠れ名所数、探検した国数、平均カオス度

#### フロントエンド/バックエンド分担
- **フロントエンド**: 
  - 統計データのグラフィカル表示
  - 旅行履歴の一覧表示（フィルタリング、ソート機能）
  - レスポンシブ対応
  - リアルタイム更新（統計データの動的更新）
- **バックエンド**: 
  - ユーザー統計データの集計・生成
  - 旅行履歴データの取得・管理
  - パフォーマンス最適化（キャッシュ戦略）
  - 発見の洞察データ生成

#### パフォーマンス要件
- 初期表示: 3秒以内
- データ更新: 1秒以内
- 同時アクセス: 50ユーザー

### 4. 旅行計画作成機能

#### 機能概要
- 旅行の基本情報入力（行き先、期間、予算）
- カオス度設定（予測不可能性のレベル選択）
- 除外設定（有名観光地、日本語対応店舗、混雑エリアの除外選択）
- AIによる隠れ名所の自動発見・旅程生成

#### 実装方式
- **方式**: フォーム入力 → AI解析 → 結果表示
- **AI処理**: Amazon Bedrockを使用した現地語レビュー解析
- **最大処理時間**: 30秒以内
- **カオス度**: 1（安全第一）〜 5（完全カオス）の5段階

#### フロントエンド/バックエンド分担
- **フロントエンド**: 
  - 多段階フォーム表示（基本情報、カオス度、除外設定）
  - リアルタイムバリデーション
  - プログレス表示（AI処理中の進捗表示）
  - カオス度の説明とプレビュー機能
- **バックエンド**: 
  - フォームデータの検証・保存
  - AI（Amazon Bedrock）による隠れ名所発見処理
  - 現地語レビューの解析・スコアリング
  - 旅程の自動生成アルゴリズム
  - 除外条件に基づくフィルタリング

#### ビジネスルール
- カオス度4以上では警告メッセージ表示
- 除外設定によるスポット選別
- 現地評価4.0以上のスポットのみ選択
- 観光地化率0%の維持（母国語レビューが存在しないスポットのみ）

### 5. 旅行結果表示機能

#### 機能概要
- AI生成された隠れ名所の詳細表示
- 日別旅程表示
- 現地情報（基本フレーズ、冒険のコツ、緊急時サポート）
- 旅程の保存・共有機能

#### データ設計
- **隠れ名所情報**: 名前、タイプ、説明、現地評価、レビュー数、言語、価格帯、特徴
- **旅程情報**: 日別アクティビティ、時間、タイプ（移動、食事、探索、体験、冒険、準備）
- **現地情報**: 基本フレーズ、緊急連絡先、日本領事館情報

#### フロントエンド/バックエンド分担
- **フロントエンド**: 
  - タブ形式での情報表示（隠れ名所、旅程表、現地情報）
  - 画像ギャラリー表示
  - 印刷対応・PDF生成
  - SNS共有機能
  - レスポンシブ対応（モバイル表示最適化）
- **バックエンド**: 
  - 旅行結果データの生成・保存
  - 画像データの管理
  - PDF生成処理
  - 共有URL生成
  - データの永続化

#### パフォーマンス要件
- 結果表示: 2秒以内
- PDF生成: 10秒以内
- 画像読み込み: 遅延読み込み対応

## 認証・認可の要否判定

**認証が必要** - 以下の理由により認証機能を実装

### 認証が必要な理由
1. **個人化された体験**: ユーザーごとの旅行履歴、統計、設定の保存
2. **旅行計画の保存**: 作成した旅行計画の永続化と再利用
3. **コミュニティ機能**: 将来的な旅行体験の共有、レビュー機能
4. **サービス利用制限**: AI処理コストの管理、スパム防止
5. **カスタマイゼーション**: ユーザーの嗜好学習による推薦精度向上

### 認証フロー
1. フロントエンドでFirebase Authentication認証
2. IDトークン取得
3. API呼び出し時に`Authorization: Bearer idToken`で送信
4. バックエンドでIDトークンを検証
5. 検証成功時はデコードされたユーザー情報を使用

## ファイルアップロード設計

**現時点では不要** - 将来的な拡張として以下を想定

### 将来的な実装案
- **プロフィール画像**: ユーザーアバター設定
- **旅行写真**: 隠れ名所での写真投稿・共有機能
- **実装方式**: Cloud Storage for Firebase使用
- **保存先**: Firebase Storage
- **最大サイズ**: 5MB
- **許可形式**: JPG, PNG

## フロントエンド/バックエンド処理分担

### フロントエンド責任範囲
- **UI/UX**: レスポンシブデザイン、ユーザーインタラクション
- **状態管理**: ログイン状態、フォーム状態、アプリケーション状態
- **Firebase連携**: Authentication、将来的なFirestore連携
- **API通信**: バックエンドとのHTTP通信
- **クライアントサイドバリデーション**: フォーム入力検証
- **プレゼンテーション**: データ表示、チャート、レポート生成

### バックエンド責任範囲
- **認証・認可**: IDトークン検証、権限管理
- **ビジネスロジック**: 旅行計画作成、隠れ名所発見アルゴリズム
- **AI処理**: Amazon Bedrockとの連携、現地語レビュー解析
- **データ管理**: PostgreSQLでのデータ永続化
- **API提供**: RESTful API、OpenAPI仕様準拠
- **外部連携**: 地図API、レビューAPI、翻訳API
- **サーバーサイドバリデーション**: 入力データ検証
- **パフォーマンス最適化**: キャッシュ、最適化クエリ

## システム境界

### 内部システム
- **フロントエンド**: Next.js Webアプリケーション
- **バックエンドAPI**: Hono + TypeScript
- **データベース**: PostgreSQL
- **認証**: Firebase Authentication

### 外部システム連携
- **AI処理**: Amazon Bedrock（現地語レビュー解析）
- **地図・位置情報**: Google Maps API（将来実装）
- **レビューデータ**: 各国のレビューサイトAPI
- **翻訳**: Google Translate API（将来実装）
- **決済**: Stripe（将来実装）

## 非機能要件

### パフォーマンス
- **ページ読み込み**: 3秒以内
- **API応答時間**: 1秒以内（AI処理除く）
- **AI処理**: 30秒以内
- **同時接続**: 100ユーザー

### セキュリティ
- **HTTPS**: 全通信の暗号化
- **認証**: Firebase Authentication
- **API保護**: IDトークン検証
- **入力検証**: XSS、SQLインジェクション対策
- **プライバシー**: 個人情報の適切な管理

### 可用性
- **稼働率**: 99.5%以上
- **バックアップ**: 日次データバックアップ
- **モニタリング**: エラー監視、パフォーマンス監視
- **災害対策**: クラウドインフラの活用

### スケーラビリティ
- **水平スケーリング**: コンテナベースのデプロイ
- **データベース**: 読み取り専用レプリカの活用
- **CDN**: 静的コンテンツの配信最適化
- **キャッシュ**: Redis等のキャッシュ層導入