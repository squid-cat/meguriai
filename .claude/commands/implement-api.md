---
description: APIの実装を行います
---

前工程で作成したAPI設計とスタブ実装を元に、実際の機能を実装します。

## 参照する設計書

- 機能設計書: `documents/docs/feature-design/[機能名].md`
- API設計書: `documents/docs/api-design/[機能名].md`
- 既存のスタブ実装: `packages/api/src/routes/[機能名]/`

## 実装内容

`docs/api_development_guideline.md` に従って、以下の実装を行います：

### 1. ビジネスロジックの実装

- **サービス層の実装**
  - `packages/api/src/services/[機能名]/` にビジネスロジックを実装
  - 単一責任の原則に従い、各サービスは特定の責務のみを持つ
  - テスト可能な設計（依存性注入等）

- **データアクセス層の実装**
  - Prismaを使用したデータベースアクセス
  - 必要に応じてリポジトリパターンの適用
  - トランザクション処理の実装

### 2. エラーハンドリング

- **カスタムエラークラスの実装**
  - ビジネスロジックエラーの定義
  - HTTPステータスコードへのマッピング
  
- **エラーミドルウェアの実装**
  - 統一的なエラーレスポンス形式
  - ログ出力の実装

### 3. バリデーションとセキュリティ

- **入力値検証**
  - zod-openapiで定義したスキーマによる自動バリデーション
  - ビジネスルールに基づく追加バリデーション
  
- **セキュリティ対策**
  - SQLインジェクション対策（Prismaによる自動対策）
  - 認証・認可の実装（必要な場合）
  - レート制限の実装（必要な場合）

### 4. パフォーマンス最適化

- **データベースクエリの最適化**
  - N+1問題の解決
  - 適切なインデックスの設定
  - クエリの効率化
  
- **キャッシュの実装**（必要な場合）
  - Redis等を使用したキャッシュ戦略
  - キャッシュの無効化戦略

### 5. テストの実装

- **単体テスト**
  - サービス層のテスト
  - ユーティリティ関数のテスト
  
- **統合テスト**
  - APIエンドポイントのテスト
  - データベースを含むテスト

### 6. ドキュメントの更新

- API実装の詳細をドキュメントに反映
- 使用例やサンプルコードの追加
- 注意事項や制限事項の記載

## 実装ファイル構成

```
packages/api/src/
├── routes/[機能名]/
│   ├── index.ts        # ルート定義（既存）
│   ├── schemas.ts      # スキーマ定義（既存）
│   └── handlers.ts     # ハンドラー実装（更新）
├── services/[機能名]/
│   ├── index.ts        # サービスのエクスポート
│   └── *.service.ts   # 各サービスの実装
├── repositories/[機能名]/
│   └── *.repository.ts # リポジトリ実装（必要な場合）
└── utils/
    └── errors.ts       # カスタムエラークラス
```

実装完了後、すべてのAPIが設計通りに動作することを確認します。